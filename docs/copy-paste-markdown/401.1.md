# Grouper Training Environment - text to copy and paste - 401.1

# VPN Access Control part 1

## Learning Objectives

- Use group math and reference groups to analyze legacy authorization groups
- Translate natural language policy into Grouper digital policy
- Implement distributed access management
- Use Grouper to answer access management questions such as “who” and “why”

## Hands On

### Analyze legacy VPN authorization group

Gain insight into who has access to VPN based on the vpn_users LDAP group. We’ll do this by using well established reference groups for faculty, staff, and students. First review the legacy VPN authorization group in LDAP.

* Log in to https://localhost:8443/phpldapadmin with username `cn=root,dc=internet2,dc=edu` and password `password`
* Expand ou=groups, and click on cn=vpn_users. Note the multi-valued "member" field.
* Create a `vpn` folder under the test folder.
* Create a `vpn_legacy` group to load the ldap group
* Add Loader settings to _vpn_legacy_ (More -> Loader -> Loader actions -> Edit loader configuration)
    - Loader: Yes, has loader configuration
    - Source Type: LDAP
    - Loader type: LDAP_SIMPLE
    - Server ID: demo
    - LDAP filter: `(cn=vpn_users)`
    - Subject attribute name: `member`
    - Search base DN: `ou=groups,dc=internet2,dc=edu`
    - Schedule: `0 * * * * ?`
    - Subject source ID: eduLDAP - EDU Ldap
    - Subject lookup type: subjectIdentifier
    - Search scope: SUBTREE_SCOPE
    - Priority:
    - Subject expression: `${loaderLdapElUtils.convertDnToSpecificValue(subjectId)}`
    - Require members in other group(s):
    - Schedule job: Yes, schedule and enable this job
* Run Loader diagnostics (Loader actions -> Loader diagnostics -> Run loader diagnostics)
* Run loader (Loader actions -> Run loader process to sync group)
* Review loader logs. How many subjects were added? (Loader actions -> View loader logs)
* Review _vpn_legacy_ members

### Analyze legacy VPN members

We will use test composite groups to gain insight into the type of cohorts in vpn_legacy by intersecting it with well known reference groups for faculty and staff.

* Create group `test:vpn:vpn_facstaff` and make it a composite intersection of _ref:role:all_facstaff_ and _test:vpn:vpn_legacy_. This represents existing faculty/staff with VPN access
* Create group `test:vpn:vpn_legacy_exceptions` and make it a complement group of _vpn_legacy_ minus _all_facstaff_. This shows users who have VPN access but are not faculty or staff

Another way to get the non-Faculty/Staff users is to use a membership filter. Use advanced membership search Group filter on the _vpn_legacy_ group to only see subjects that are not faculty/staff.

### Get a list of current exceptions

Before going live with the new group, we want to have the current exceptions looked at

* Export the membership of _test:vpn:vpn_legacy_exceptions_ (More actions -> Export Members)

### Get a list of current exceptions (Extra)

If the exception list is long, it will speed up review by listing the basis groups for each user

* Run the SQL query from the Copy/paste to summarize basis groups for the exceptions


```
select distinct M.subject_id, M.subject_identifier0, M.name, group_concat(distinct G.display_extension) as "Basis Groups" from grouper_memberships_all_v V
join grouper_members M on V.member_id = M.id
join grouper_groups G on V.owner_group_id = G.id
where (G.name like 'basis:hr:employee:dept:%' or G.name like 'basis:sis:prog_status:year:%')
and M.subject_source = 'eduLDAP'
and M.subject_id in (
  select distinct subject_id from grouper_memberships_all_v V
  join grouper_members M on V.member_id = M.id
  join grouper_groups G on V.owner_group_id = G.id
  where G.name = 'test:vpn:vpn_legacy_exceptions'
  and M.subject_source = 'eduLDAP'
) group by M.subject_id
order by M.subject_id;
```
